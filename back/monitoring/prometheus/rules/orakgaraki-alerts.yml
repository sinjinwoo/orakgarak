groups:
  # μ• ν”λ¦¬μΌ€μ΄μ… κ΄€λ ¨ μ•λ¦Ό
  - name: orakgaraki.application
    rules:
      # μ• ν”λ¦¬μΌ€μ΄μ… μ„λ²„ λ‹¤μ΄
      - alert: ApplicationDown
        expr: up{job="orakgaraki-app"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "μ¤λ½κ°€λ½μ΄ μ• ν”λ¦¬μΌ€μ΄μ…μ΄ μ¤‘λ‹¨λμ—μµλ‹λ‹¤"
          description: "μ¤λ½κ°€λ½μ΄ μ• ν”λ¦¬μΌ€μ΄μ…μ΄ 1λ¶„ μ΄μƒ μ¤‘λ‹¨λ μƒνƒμ…λ‹λ‹¤."

      # λ†’μ€ μ‘λ‹µ μ‹κ°„
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_server_requests_seconds_bucket{job="orakgaraki-app"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "λ†’μ€ μ‘λ‹µ μ‹κ°„μ΄ κ°μ§€λμ—μµλ‹λ‹¤"
          description: "95% μ‘λ‹µ μ‹κ°„μ΄ {{ $value }}μ΄λ΅ 5λ¶„ μ΄μƒ μ§€μ†λκ³  μμµλ‹λ‹¤."

      # λ†’μ€ μ—λ¬μ¨
      - alert: HighErrorRate
        expr: rate(http_server_requests_total{job="orakgaraki-app",status=~"5.."}[5m]) / rate(http_server_requests_total{job="orakgaraki-app"}[5m]) > 0.1
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "λ†’μ€ μ¤λ¥μ¨μ΄ κ°μ§€λμ—μµλ‹λ‹¤"
          description: "μ¤λ¥μ¨μ΄ {{ $value | humanizePercentage }}λ΅ 3λ¶„ μ΄μƒ μ§€μ†λκ³  μμµλ‹λ‹¤."

      # JVM λ©”λ¨λ¦¬ μ‚¬μ©λ¥  λ†’μ
      - alert: HighJVMMemoryUsage
        expr: (jvm_memory_used_bytes{job="orakgaraki-app",area="heap"} / jvm_memory_max_bytes{job="orakgaraki-app",area="heap"}) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "JVM ν™ λ©”λ¨λ¦¬ μ‚¬μ©λ¥ μ΄ λ†’μµλ‹λ‹¤"
          description: "JVM ν™ λ©”λ¨λ¦¬ μ‚¬μ©λ¥ μ΄ {{ $value | humanizePercentage }}λ΅ 5λ¶„ μ΄μƒ μ§€μ†λκ³  μμµλ‹λ‹¤."

  # μΈν”„λΌ κ΄€λ ¨ μ•λ¦Ό
  - name: orakgaraki.infrastructure
    rules:
      # λ†’μ€ CPU μ‚¬μ©λ¥ 
      - alert: HighCPUUsage
        expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "λ†’μ€ CPU μ‚¬μ©λ¥ μ΄ κ°μ§€λμ—μµλ‹λ‹¤"
          description: "μΈμ¤ν„΄μ¤ {{ $labels.instance }}μ—μ„ CPU μ‚¬μ©λ¥ μ΄ {{ $value }}%λ΅ 5λ¶„ μ΄μƒ μ§€μ†λκ³  μμµλ‹λ‹¤."

      # λ†’μ€ λ©”λ¨λ¦¬ μ‚¬μ©λ¥ 
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "λ†’μ€ λ©”λ¨λ¦¬ μ‚¬μ©λ¥ μ΄ κ°μ§€λμ—μµλ‹λ‹¤"
          description: "μΈμ¤ν„΄μ¤ {{ $labels.instance }}μ—μ„ λ©”λ¨λ¦¬ μ‚¬μ©λ¥ μ΄ {{ $value | humanizePercentage }}λ΅ 5λ¶„ μ΄μƒ μ§€μ†λκ³  μμµλ‹λ‹¤."

      # λ””μ¤ν¬ μ‚¬μ©λ¥  λ†’μ
      - alert: HighDiskUsage
        expr: (1 - (node_filesystem_free_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "λ†’μ€ λ””μ¤ν¬ μ‚¬μ©λ¥ μ΄ κ°μ§€λμ—μµλ‹λ‹¤"
          description: "λ§μ΄νΈ ν¬μΈνΈ {{ $labels.mountpoint }}μ—μ„ λ””μ¤ν¬ μ‚¬μ©λ¥ μ΄ {{ $value | humanizePercentage }}λ΅ 5λ¶„ μ΄μƒ μ§€μ†λκ³  μμµλ‹λ‹¤."

  # λ°μ΄ν„°λ² μ΄μ¤ κ΄€λ ¨ μ•λ¦Ό
  - name: orakgaraki.database
    rules:
      # MySQL μ„λ²„ λ‹¤μ΄
      - alert: MySQLDown
        expr: up{job="mysql"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MySQL μ„λ²„κ°€ μ¤‘λ‹¨λμ—μµλ‹λ‹¤"
          description: "MySQL μ„λ²„κ°€ 1λ¶„ μ΄μƒ μ¤‘λ‹¨λ μƒνƒμ…λ‹λ‹¤."

      # MySQL μ—°κ²° μ λ†’μ
      - alert: MySQLHighConnections
        expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQL μ—°κ²° μ‚¬μ©λ¥ μ΄ λ†’μµλ‹λ‹¤"
          description: "MySQL μ—°κ²° μ‚¬μ©λ¥ μ΄ {{ $value | humanizePercentage }}λ΅ 5λ¶„ μ΄μƒ μ§€μ†λκ³  μμµλ‹λ‹¤."

      # Redis μ„λ²„ λ‹¤μ΄
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis μ„λ²„κ°€ μ¤‘λ‹¨λμ—μµλ‹λ‹¤"
          description: "Redis μ„λ²„κ°€ 1λ¶„ μ΄μƒ μ¤‘λ‹¨λ μƒνƒμ…λ‹λ‹¤."

      # Redis λ©”λ¨λ¦¬ μ‚¬μ©λ¥  λ†’μ (μ‹μ¤ν… λ©”λ¨λ¦¬ κΈ°μ¤€)
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / (1024*1024*1024) > 0.5
        for: 5m
        labels:
          severity: warning
          service: "redis"
          metric_type: "memory"
        annotations:
          summary: "π¨ Redis λ©”λ¨λ¦¬ μ‚¬μ©λ‰ κ²½κ³ "
          description: "Redis λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ΄ {{ $value | printf \"%.1f\" }}GBλ¥Ό μ΄κ³Όν–μµλ‹λ‹¤. ν„μ¬ μ‚¬μ©λ‰: {{ with query \"redis_memory_used_bytes\" }}{{ . | first | value | humanize1024 }}B{{ end }}"

      # Redis λ©”λ¨λ¦¬ μ‚¬μ©λ¥  λ†’μ (RSS κΈ°μ¤€)
      - alert: RedisHighMemoryUsageRSS
        expr: redis_memory_rss_bytes / redis_memory_used_bytes > 1.5
        for: 5m
        labels:
          severity: warning
          service: "redis"
          metric_type: "memory_fragmentation"
        annotations:
          summary: "β οΈ Redis λ©”λ¨λ¦¬ λ‹¨νΈν™” κ²½κ³ "
          description: "Redis λ©”λ¨λ¦¬ λ‹¨νΈν™”κ°€ μ‹¬κ°ν•©λ‹λ‹¤. RSS/Used λΉ„μ¨: {{ $value | printf \"%.2f\" }}λ°° (κ¶μ¥: 1.5λ°° μ΄ν•)"

  # Kafka κ΄€λ ¨ μ•λ¦Ό
  - name: orakgaraki.kafka
    rules:
      # Kafka μ„λ²„ λ‹¤μ΄
      - alert: KafkaDown
        expr: up{job="kafka"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kafka μ„λ²„κ°€ μ¤‘λ‹¨λμ—μµλ‹λ‹¤"
          description: "Kafka μ„λ²„κ°€ 1λ¶„ μ΄μƒ μ¤‘λ‹¨λ μƒνƒμ…λ‹λ‹¤."

      # Kafka μ»¨μλ¨Έ λ™ λ†’μ
      - alert: KafkaConsumerLag
        expr: kafka_consumer_lag_sum{topic="upload-events"} > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka μ»¨μλ¨Έ μ§€μ—°μ΄ λ†’μµλ‹λ‹¤"
          description: "ν† ν”½ {{ $labels.topic }}μ μ»¨μλ¨Έ μ§€μ—°μ΄ {{ $value }}κ° λ©”μ‹μ§€λ΅ 5λ¶„ μ΄μƒ μ§€μ†λκ³  μμµλ‹λ‹¤."

  # μ»¨ν…μ΄λ„ κ΄€λ ¨ μ•λ¦Ό
  - name: orakgaraki.containers
    rules:
      # μ»¨ν…μ΄λ„ μ¬μ‹μ‘ λΉλ°
      - alert: ContainerRestartingFrequently
        expr: increase(container_start_time_seconds[1h]) > 3
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "μ»¨ν…μ΄λ„κ°€ μμ£Ό μ¬μ‹μ‘λκ³  μμµλ‹λ‹¤"
          description: "μ»¨ν…μ΄λ„ {{ $labels.name }}μ΄ μ§€λ‚ 1μ‹κ°„ λ™μ• {{ $value }}λ² μ¬μ‹μ‘λμ—μµλ‹λ‹¤."

      # μ»¨ν…μ΄λ„ λ†’μ€ CPU μ‚¬μ©λ¥ 
      - alert: ContainerHighCPUUsage
        expr: rate(container_cpu_usage_seconds_total{name!=""}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "μ»¨ν…μ΄λ„ CPU μ‚¬μ©λ¥ μ΄ λ†’μµλ‹λ‹¤"
          description: "μ»¨ν…μ΄λ„ {{ $labels.name }}μ CPU μ‚¬μ©λ¥ μ΄ {{ $value | humanizePercentage }}λ΅ 5λ¶„ μ΄μƒ μ§€μ†λκ³  μμµλ‹λ‹¤."

      # μ»¨ν…μ΄λ„ λ†’μ€ λ©”λ¨λ¦¬ μ‚¬μ©λ¥ 
      - alert: ContainerHighMemoryUsage
        expr: container_memory_usage_bytes{name!=""} / container_spec_memory_limit_bytes{name!=""} > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "μ»¨ν…μ΄λ„ λ©”λ¨λ¦¬ μ‚¬μ©λ¥ μ΄ λ†’μµλ‹λ‹¤"
          description: "μ»¨ν…μ΄λ„ {{ $labels.name }}μ λ©”λ¨λ¦¬ μ‚¬μ©λ¥ μ΄ {{ $value | humanizePercentage }}λ΅ 5λ¶„ μ΄μƒ μ§€μ†λκ³  μμµλ‹λ‹¤."